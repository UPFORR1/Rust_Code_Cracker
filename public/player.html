<!DOCTYPE html>
<html><head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">
  <title>Rust Cracker</title>
  <link rel="icon" href="/favicon.ico">
  <link rel="stylesheet" href="/style.css">
</head><body>
  <div class="glass-card">
    <h1>RUST CODES</h1>
    <div class="player-code" id="playerNumber">Loading…</div>
    <div class="session-id" id="sessionId"></div>

    <div class="button-row">
      <button class="prev-button" onclick="prev()">Prev</button>
      <button class="next-button" onclick="next()">Next</button>
    </div>

    <div class="stats-title">Overall Team Progress: <span id="overallProgress">0.00%</span></div>
    <div class="stat-container"><div class="stat-bar" id="overallBar"></div></div>

    <div class="stats-title">Your Progress: <span id="yourProgress">0.00%</span></div>
    <div class="stat-container"><div class="stat-bar" id="yourBar"></div></div>

    <div class="stats-title">All Players:</div>
    <div id="allPlayers"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const params       = new URLSearchParams(location.search);
    const sessionId    = params.get('session');
    const totalPlayers = parseInt(params.get('total'),10) || 4;

    const socket = io({ query: { session: sessionId, total: totalPlayers } });

    let playerIndex, assignedCodes = [], currentIdx = 0;
    let progressArr   = Array(totalPlayers).fill(0);

    // try reconnect
    const saved = localStorage.getItem(`playerIndex_${sessionId}`);
    if (saved !== null) socket.emit('reconnectPlayer', +saved);
    else                socket.emit('newPlayer');

    socket.on('assignedIndex', idx => {
      playerIndex = idx;
      localStorage.setItem(`playerIndex_${sessionId}`, idx);
      document.getElementById('sessionId').innerText = `Session: ${sessionId}`;
    });

    // ← this is the magic line: once the server sends your codes,
    //     we store them and immediately call showCode()
    socket.on('codeList', list => {
      assignedCodes = list;
      const savedPos = localStorage.getItem(`codeIdx_${sessionId}_${playerIndex}`);
      if (savedPos!==null && +savedPos < assignedCodes.length) {
        currentIdx = +savedPos;
      }
      showCode();
      sendProgressUpdate();
    });

    socket.on('updateProgress', data => {
      progressArr = data.playerProgress;
      renderStats();
    });

    socket.on('reclaimDenied', () => alert('Slot already taken'));
    socket.on('error', msg => alert(msg));

    function showCode() {
      document.getElementById('playerNumber').innerText =
        `Player ${playerIndex+1} | Code: ${assignedCodes[currentIdx]}`;
      renderStats();
    }

    function sendProgressUpdate() {
      const pct = (currentIdx / (assignedCodes.length-1)) * 100;
      socket.emit('progressUpdate', pct);
    }

    function nav(dir, color) {
      const next = currentIdx + dir;
      if (next<0 || next>=assignedCodes.length) return;
      currentIdx = next;
      localStorage.setItem(`codeIdx_${sessionId}_${playerIndex}`, currentIdx);
      showCode();
      sendProgressUpdate();
      flash(color);
    }
    function prev(){ nav(-1,'red'); }
    function next(){ nav(+1,'green'); }

    function renderStats(){
      const your = progressArr[playerIndex]||0;
      document.getElementById('yourProgress').innerText = your.toFixed(2)+'%';
      document.getElementById('yourBar').style.width = your+'%';

      const sum = progressArr.reduce((a,b)=>a+b,0);
      const overall = sum/totalPlayers;
      document.getElementById('overallProgress').innerText = overall.toFixed(2)+'%';
      document.getElementById('overallBar').style.width = overall+'%';

      const allDiv = document.getElementById('allPlayers');
      allDiv.innerHTML = '';
      progressArr.forEach((p,i)=>{
        const lbl = document.createElement('div');
        lbl.textContent = `Player ${i+1}: ${p.toFixed(2)}%`;
        const barC = document.createElement('div');
        barC.className = 'stat-container';
        const bar = document.createElement('div');
        bar.className = 'stat-bar';
        bar.style.width = p+'%';
        barC.appendChild(bar);
        allDiv.append(lbl, barC);
      });
    }

    function flash(color){
      const card = document.querySelector('.glass-card');
      card.classList.add(color==='green'?'flash-green':'flash-red');
      setTimeout(()=>card.classList.remove('flash-green','flash-red'),300);
    }
  </script>
</body></html>
